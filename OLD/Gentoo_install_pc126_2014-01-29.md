---
layout: page
title: "Gentoo installation notes (jan. 2014)"
description: "Some notes about /me re-installing my Gentoo boxes from scratch."
published: false
---

## A. ...

### mke2fs

	pc126 ~ # mke2fs -t ext4 -v -j -L "Gentoonette" -O extents,dir_index -T small /dev/sda5
	mke2fs 1.42.7 (21-Jan-2013)
	fs_types for mke2fs.conf resolution: 'ext4', 'small'
	Filesystem label=Gentoonette
	OS type: Linux
	Block size=1024 (log=0)
	Fragment size=1024 (log=0)
	Stride=0 blocks, Stripe width=0 blocks
	16896000 inodes, 67584000 blocks
	3379200 blocks (5.00%) reserved for the super user
	First data block=1
	Maximum filesystem blocks=134742016
	8250 block groups
	8192 blocks per group, 8192 fragments per group
	2048 inodes per group
	Superblock backups stored on blocks:
		8193, 24577, 40961, 57345, 73729, 204801, 221185, 401409, 663553,
		1024001, 1990657, 2809857, 5120001, 5971969, 17915905, 19668993,
		25600001, 53747713

	Allocating group tables: done
	Writing inode tables: done
	Creating journal (32768 blocks): done
	Writing superblocks and filesystem accounting information: done

### (optional) Update host's /etc/fstab

	pc126 ~ # dumpe2fs -h /dev/sda5 | grep UUID
	dumpe2fs 1.42.7 (21-Jan-2013)
	Filesystem UUID:          1220ff2d-63ac-45fe-a05e-0a4c5fa0e475


	pc126 ~ # cat >> /etc/fstab << EOF
	>
	> # /dev/sda5
	> UUID=1220ff2d-63ac-45fe-a05e-0a4c5fa0e475 /mnt/g ext4 noatime 0 0
	> EOF

	pc126 ~ # mount -a

### stage3 tarball

	pc126 ~ # cp ~cadet/Downloads/stage3-amd64-20140116.tar.bz2* /mnt/g/
	pc126 g # cd /mnt/g
	pc126 g # tar -xvpf stage3-amd64-20140116.tar.bz2

### etc/portage/make.conf

	pc126 g # emerge mirrorselect
	pc126 g # mirrorselect -i -o    >> /mnt/g/etc/portage/make.conf
	pc126 g # mirrorselect -i -r -o >> /mnt/g/etc/portage/make.conf

	pc126 g # vi etc/portage/make.conf
		CFLAGS="-O2 -pipe -march=core2"
		MAKEOPTS="-j2"
		# For elogv & elogviewer :
		PORTAGE_ELOG_SYSTEM="save echo"
		PORTAGE_ELOG_CLASSES="warn error info log qa"
		# Mirrors (distfiles & rsync) :
		GENTOO_MIRRORS="http://mirror.ovh.net/gentoo-distfiles/"
		SYNC="rsync://rsync.fr.gentoo.org/gentoo-portage"

	pc126 g # cat /etc/resolv.conf
	# Generated by NetworkManager
	search pallas.cines.fr cines.fr
	nameserver 193.48.169.40
	nameserver 195.83.180.9

### etc/resolv.conf

	pc126 g # cp -Liv /etc/resolv.conf /mnt/g/etc/
	'/etc/resolv.conf' -> '/mnt/g/etc/resolv.conf'


## B. ...

### Mount kernel filesystems

	pc126 g # mount -t proc proc /mnt/g/proc
	pc126 g # mount --rbind /sys /mnt/g/sys
	pc126 g # mount --rbind /dev /mnt/g/dev

### chroot

	pc126 g # chroot /mnt/g /bin/bash
	pc126 / # source /etc/profile
	pc126 / # export PS1="(chroot) $PS1"
	pc126 / # cd ~

### systemd : /etc/mtab symlink to /proc/self/mounts

See <https://wiki.gentoo.org/wiki/Systemd#.2Fetc.2Fmtab>

	(chroot) pc126 ~ # ln -sf /proc/self/mounts /etc/mtab

### Fetch a Portage snapshot

	(chroot) pc126 ~ # time emerge-webrsync
	(chroot) pc126 ~ # time emerge --sync
	(chroot) pc126 ~ # eselect news list

### Portage profile

	(chroot) pc126 ~ # eselect profile list
	Available profile symlink targets:
	  [1]   default/linux/amd64/13.0 *
	  [2]   default/linux/amd64/13.0/selinux
	  [3]   default/linux/amd64/13.0/desktop
	  [4]   default/linux/amd64/13.0/desktop/gnome
	  [5]   default/linux/amd64/13.0/desktop/gnome/systemd
	  [6]   default/linux/amd64/13.0/desktop/kde
	  [7]   default/linux/amd64/13.0/desktop/kde/systemd
	  [8]   default/linux/amd64/13.0/developer
	  [9]   default/linux/amd64/13.0/no-multilib
	  [10]  default/linux/amd64/13.0/x32
	  [11]  hardened/linux/amd64
	  [12]  hardened/linux/amd64/selinux
	  [13]  hardened/linux/amd64/no-multilib
	  [14]  hardened/linux/amd64/no-multilib/selinux
	  [15]  hardened/linux/amd64/x32
	  [16]  hardened/linux/uclibc/amd64

	(chroot) pc126 ~ # eselect profile set 5

### Vim

	(chroot) pc126 ~ # USE='-X ' emerge -avt app-editors/vim

	These are the packages that would be merged, in reverse order:

	Calculating dependencies... done!
	[nomerge       ] app-editors/vim-7.3.762  USE="acl gpm nls -X -cscope -debug -minimal -perl -python -ruby -vim-pager"
	[nomerge       ]  app-editors/vim-core-7.3.762  USE="acl nls -livecd"
	[ebuild  N     ]   app-vim/gentoo-syntax-20130619  USE="-ignore-glep31" 25 kB
	[ebuild  N     ]    app-editors/vim-7.3.762  USE="acl gpm nls -X -cscope -debug -minimal -perl -python -ruby -vim-pager" 9,945 kB
	[ebuild  N     ]     app-editors/vim-core-7.3.762  USE="acl nls -livecd" 3 kB
	[ebuild  N     ]     sys-libs/gpm-1.20.7-r1  USE="(-selinux) -static-libs" 772 kB
	[ebuild  N     ]     dev-util/ctags-5.8  USE="-ada" 469 kB
	[ebuild  N     ]      app-admin/eselect-ctags-1.14  8 kB
	[ebuild  N     ]     app-admin/eselect-vi-1.1.7-r1  2 kB

	Total: 7 packages (7 new), Size of downloads: 11,222 kB

	Would you like to merge these packages? [Yes/No]

### Timezone & locales

#### /etc/timezone

	(chroot) pc126 ~ # echo "Europe/Paris" > /etc/timezone

	(chroot) pc126 ~ # emerge --config sys-libs/timezone-data

#### Locales

	(chroot) pc126 ~ # cat >> /etc/locale.gen << EOF
	>
	> en_US ISO-8859-1
	> en_US.UTF-8 UTF-8
	> fr_FR ISO-8859-1
	> fr_FR@euro ISO-8859-15
	>
	> EOF

	(chroot) pc126 ~ # locale -a
	C
	POSIX

	(chroot) pc126 ~ # locale-gen
	 * Generating 4 locales (this might take a while) with 1 jobs
	 *  (1/4) Generating en_US.ISO-8859-1 ... [ ok ]
	 *  (2/4) Generating en_US.UTF-8 ... [ ok ]
	 *  (3/4) Generating fr_FR.ISO-8859-1 ... [ ok ]
	 *  (4/4) Generating fr_FR.ISO-8859-15@euro ... [ ok ]
	 * Generation complete

	(chroot) pc126 ~ # locale -a
	C
	POSIX
	en_US
	en_US.iso88591
	en_US.utf8
	fr_FR
	fr_FR.iso88591
	fr_FR.iso885915@euro
	fr_FR@euro
	fran�ais
	french

	(chroot) pc126 ~ # eselect locale list
	Available targets for the LANG variable:
	  [1]   C
	  [2]   POSIX
	  [3]   en_US
	  [4]   en_US.iso88591
	  [5]   en_US.utf8
	  [6]   fr_FR
	  [7]   fr_FR.iso88591
	  [8]   fr_FR.iso885915@euro
	  [9]   fr_FR@euro
	  [10]  fran�ais
	  [11]  french
	  [ ]   (free form)

	(chroot) pc126 ~ # eselect locale set en_US.utf8
	Setting LANG to en_US.utf8 ...
	Run ". /etc/profile" to update the variable in your shell.

	(chroot) pc126 ~ # env-update && source /etc/profile
	>>> Regenerating /etc/ld.so.cache...

	pc126 ~ # export PS1="(chroot) $PS1"
	(chroot) pc126 ~ #


### Emerge some more stuff

	(chroot) pc126 ~ # time emerge -avt syslog-ng dcron mlocate gentoolkit

	These are the packages that would be merged, in reverse order:

	Calculating dependencies... done!
	[ebuild  N     ] app-portage/gentoolkit-0.3.0.8-r2  PYTHON_TARGETS="python2_7 python3_3 (-pypy2_0) -python2_6 -python3_2" 3,118 kB
	[ebuild  N     ] sys-apps/mlocate-0.26  USE="nls (-selinux)" 351 kB
	[ebuild  N     ] sys-process/dcron-4.5-r1  44 kB
	[ebuild  N     ] app-admin/syslog-ng-3.4.2  USE="ipv6 pcre ssl tcpd -caps -dbi -geoip -json -mongodb -smtp -spoof-source" 3,277 kB
	[nomerge       ] app-portage/gentoolkit-0.3.0.8-r2  PYTHON_TARGETS="python2_7 python3_3 (-pypy2_0) -python2_6 -python3_2"
	[nomerge       ]  dev-lang/python-exec-2.0.1:2  PYTHON_TARGETS="(jython2_5) (jython2_7) (pypy2_0) (python2_6) (python2_7) (python3_2) (python3_3)"
	[nomerge       ]   dev-python/python-exec-10000.2:2  PYTHON_TARGETS="(jython2_5) (jython2_7) (pypy2_0) (python2_6) (python2_7) (python3_2) (python3_3)"
	[nomerge       ]    dev-lang/python-exec-0.3.1  PYTHON_TARGETS="(jython2_5) (jython2_7) (pypy2_0) (python2_6) (python2_7) (python3_2) (python3_3)"
	[ebuild  N     ]     dev-python/python-exec-10000.1  PYTHON_TARGETS="(jython2_5) (jython2_7) (pypy2_0) (python2_6) (python2_7) (python3_2) (python3_3)" 0 kB
	[ebuild  N     ]   dev-python/python-exec-10000.2:2  PYTHON_TARGETS="(jython2_5) (jython2_7) (pypy2_0) (python2_6) (python2_7) (python3_2) (python3_3)" 0 kB
	[ebuild  N     ]    dev-lang/python-exec-0.3.1  PYTHON_TARGETS="(jython2_5) (jython2_7) (pypy2_0) (python2_6) (python2_7) (python3_2) (python3_3)" 73 kB
	[ebuild  N     ]  virtual/python-argparse-1  PYTHON_TARGETS="python2_7 python3_3 (-pypy2_0) -python2_6 -python3_2" 0 kB
	[ebuild  N     ]   dev-lang/python-exec-2.0.1:2  PYTHON_TARGETS="(jython2_5) (jython2_7) (pypy2_0) (python2_6) (python2_7) (python3_2) (python3_3)" 80 kB
	[nomerge       ] app-admin/syslog-ng-3.4.2  USE="ipv6 pcre ssl tcpd -caps -dbi -geoip -json -mongodb -smtp -spoof-source"
	[ebuild  N     ]  dev-libs/eventlog-0.2.12  USE="-static-libs" 297 kB
	[nomerge       ] sys-process/dcron-4.5-r1
	[ebuild  N     ]  sys-process/cronbase-0.3.3  0 kB

	Total: 11 packages (11 new), Size of downloads: 7,238 kB

	Would you like to merge these packages? [Yes/No] y

### Emerge further stuff

	(chroot) pc126 ~ # time USE='-X' emerge -avt dhcpcd sys-boot/grub app-portage/elogv

	These are the packages that would be merged, in reverse order:

	Calculating dependencies... done!
	[ebuild  N     ] app-portage/elogv-0.7.4  16 kB
	[ebuild  N     ] sys-boot/grub-2.00_p5107-r2:2  USE="multislot nls sdl truetype -custom-cflags -debug -device-mapper -doc -efiemu (-libzfs) -mount -static {-test}" GRUB_PLATFORMS="-coreboot -efi-32 -efi-64 -emu -ieee1275 -multiboot -pc -qemu -qemu-mips -yeeloong" 7,446 kB
	[ebuild  N     ] net-misc/dhcpcd-6.2.0-r1  USE="ipv6 udev" 119 kB
	[nomerge       ] sys-boot/grub-2.00_p5107-r2:2  USE="multislot nls sdl truetype -custom-cflags -debug -device-mapper -doc -efiemu (-libzfs) -mount -static {-test}" GRUB_PLATFORMS="-coreboot -efi-32 -efi-64 -emu -ieee1275 -multiboot -pc -qemu -qemu-mips -yeeloong"
	[ebuild  N     ]  media-libs/freetype-2.4.11:2  USE="bindist bzip2 -X -auto-hinter -debug -doc -fontforge -infinality -static-libs -utils" 1,510 kB

	Total: 4 packages (4 new), Size of downloads: 9,090 kB

	Would you like to merge these packages? [Yes/No] y

### /etc/fstab

	(chroot) pc126 ~ # cat >> /etc/fstab << EOF
	>
	> # /dev/sda5
	> UUID=1220ff2d-63ac-45fe-a05e-0a4c5fa0e475 / ext4        noatime 0 1
	>
	> /dev/sda6               none            swap            sw      0 0
	>
	> # No longer needed ??
	> #proc   /proc           proc    defaults                0 0
	> #shm    /dev/shm        tmpfs   nodev,nosuid,noexec     0 0
	>
	> /dev/sda3  /media/Win7  ntfs    users,uid=cadet,gid=cadet,umask=077     0 0
	>
	> # /dev/sda7 : Previous Gentoo system.
	> UUID=067c470a-7bb5-4b08-ab59-5a3b588e5848 /media/gentoo2013 ext4 noatime 0 0
	> EOF

### Net

#### Host name

	(chroot) pc126 ~ # cat >> /etc/conf.d/hostname << EOF
	> hostname="pc126"
	> EOF

	(chroot) pc126 ~ # vi etc/conf.d/hostname

#### Domain name

	(chroot) pc126 ~ # cat >> /etc/conf.d/net << EOF
	> #dns_domain_lo="pallas.cines.fr"
	>
	> dns_domain_eth0="pallas.cines.fr"
	> dns_servers_eth0="193.48.169.40 195.83.180.9"
	> dns_search_eth0="pallas.cines.fr cines.fr"
	>
	> config_eth0=( "195.83.179.126 broadcast 195.83.179.255 netmask 255.255.255.0" )
	> routes_eth0=( "default via 195.83.179.253" )
	>
	> ntp_servers_eth0="ntp.cines.fr"
	> EOF
